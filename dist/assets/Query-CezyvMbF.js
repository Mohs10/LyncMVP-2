import{j as e,r as n,u as Q,c as I,e as A}from"./index-COlOKGVa.js";import{I as j}from"./InquiriesService-D6_IMM9T.js";import{p as B}from"./Ellipse 3-CyACr4uG.js";import{T as D}from"./Topbar-C2H_McEf.js";import{P as E}from"./Pagination-CudtAkz1.js";const U=({label:i,completed:t,timestamp:u,onAction:l,isDisabled:o})=>e.jsxs("div",{className:"timeline-item d-flex align-items-center mb-3 p-3 shadow-sm",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:`mb-1 ${t?"text-success":"text-muted"}`,children:i}),e.jsx("small",{className:"text-muted",children:u})]}),e.jsx("button",{className:`btn btn-sm ${o?"btn-secondary":"btn-dark"}`,onClick:l,disabled:o,children:t?"Completed":"Action"})]}),L=({queryId:i})=>{var g;const[t,u]=n.useState(null),l=Q();n.useEffect(()=>{(async()=>{try{const c=await j.getInquiryById(i);u(c)}catch(c){console.error("Error fetching query details:",c.message),alert("Failed to fetch query details.")}})()},[i]);const o=r=>{switch(r){case"sendQuery":l(`/send-query/${i}`);break;case"viewPriceDetails":l(`/price-details/${i}`,{state:{queryId:i,priceDetails:t.sellerNegotiations}});break;case"adminQuote":l(`/adminQuoteToBuyer/${i}`);break;case"negotiateToBuyer":l("/price-negotiation",{state:{queryId:i,productId:t.productId}});break;default:console.error("Unknown action:",r)}},x=[{id:"sendQuery",label:"Send Query",completed:!!(t!=null&&t.sentDate)},{id:"viewPriceDetails",label:"View Price Details by Seller",completed:((g=t==null?void 0:t.sellerNegotiations)==null?void 0:g.length)>0},{id:"adminQuote",label:"Admin Quote to Buyer",completed:!!(t!=null&&t.adminInitialPrice)},{id:"negotiateToBuyer",label:"Admin Negotiate to Buyer",completed:!!(t!=null&&t.buyerNegotiatePrice)}];return e.jsxs("div",{className:"timeline-container",children:[e.jsx("h5",{className:"fw-bold mb-4",children:"Timeline"}),x.map((r,c)=>e.jsx(U,{label:r.label,completed:r.completed,timestamp:r.completed?t==null?void 0:t[`${r.id}Time`]:"Pending",onAction:()=>o(r.id),isDisabled:!r.completed&&c!==0&&!x[c-1].completed},c))]})},N=3,G=()=>{const[i,t]=n.useState(null),[u,l]=n.useState([]),[o,x]=n.useState([]),[g,r]=n.useState(""),[c,y]=n.useState({}),[b,w]=n.useState(1),p=Q();I();const k=Math.ceil(o.length/N);n.useEffect(()=>{(async()=>{try{const a=await j.fetchAllInquiries();l(a)}catch(a){console.error("Error fetching inquiries:",a.message),a.message==="Token is not found or is expired."&&(alert("Session expired. Please log in again."),p("/login"))}})()},[p]),n.useEffect(()=>{(async()=>{try{const d=(await A.get("http://lyncorganikness.ap-south-1.elasticbeanstalk.com/auth/admin/allUsers",{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}})).data.reduce((m,h)=>(m[h.userId]=h.fullName,m),{});y(d)}catch(a){console.error("Error fetching user mappings:",a.message),alert("Failed to fetch user details. Please try again.")}})()},[]),n.useEffect(()=>{(async()=>{try{const f=[...await j.fetchAllInquiries()].sort((d,m)=>{const h=new Date(`${d.raiseDate}T${d.raiseTime}`);return new Date(`${m.raiseDate}T${m.raiseTime}`)-h});l(f),x(f)}catch(a){console.error("Error fetching inquiries:",a.message),a.message==="Token is not found or is expired."&&(alert("Session expired. Please log in again."),p("/login"))}})()},[p]);const P=s=>{const a=s.target.value.toLowerCase();r(a);const f=u.filter(d=>{var h;const m=((h=c[d.buyerUId])==null?void 0:h.toLowerCase())||"";return d.qid.toLowerCase().includes(a)||m.includes(a)});x(f),w(1)},T=s=>{t(a=>a===s?null:s)},S=s=>{p(`/query-details/${s.qid}`,{state:{restoredQuery:i,restoredPage:b,restoredSearch:g}})},v=(b-1)*N,$=v+N,C=o.slice(v,$);return e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx(D,{title:"Queries",userName:"Neha Sharma",showSearchBar:!1}),e.jsx("div",{className:"container mt-4",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-5",children:[e.jsx("input",{type:"text",className:"form-control yellow-border",placeholder:"Search by Query ID or User Name",value:g,onChange:P}),e.jsx("h5",{className:"my-4",children:"All Queries"}),C.map(s=>e.jsxs("div",{className:`card p-3 shadow-sm mb-3 ${i===s.qid?"selected-query":""}`,style:{cursor:"pointer",border:"1px solid #e0e0e0"},children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsxs("div",{className:"form-check",children:[e.jsx("input",{type:"checkbox",className:"form-check-input",id:`queryCheckbox${s.qid}`,checked:i===s.qid,onChange:()=>T(s.qid)}),e.jsxs("label",{className:"form-check-label ms-2",htmlFor:`queryCheckbox${s.qid}`,children:["Query ID ",s.qid]})]}),e.jsx("span",{className:`btn btn-sm btn-outline-dark ${s.status==="Pending"?"text-dark":"text-success"}`,children:s.status||"Open"})]}),e.jsxs("div",{className:"d-flex align-items-start mt-3",children:[e.jsx("img",{src:B,alt:"Profile",className:"rounded-circle",style:{width:"60px",height:"60px",marginRight:"15px"}}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:"mb-1",children:c[s.buyerUId]||"Unknown Buyer"}),e.jsx("p",{className:"mb-0 text-muted",children:`${s.productName||""} ${s.varietyName||""}`})]}),e.jsxs("div",{className:"text-end",children:[e.jsx("div",{className:"text-muted",children:"Query Date"}),e.jsx("p",{className:"mb-0",children:s.raiseDate}),e.jsx("div",{className:"text-muted mt-2",children:"Query Time"}),e.jsx("p",{className:"mb-0",children:s.raiseTime}),e.jsx("div",{className:"mb-1 text-muted mt-2",children:"Location"}),e.jsx("p",{className:"mb-0",children:`${s.city||"N/A"}, ${s.state||"N/A"}`})]})]}),e.jsx("button",{className:"btn btn-outline-dark mt-3 w-50",onClick:()=>S(s),children:"View Query Details"})]},s.qid)),e.jsx(E,{currentPage:b,totalPages:k,onPageChange:w})]}),e.jsx("div",{className:"col-md-7",children:e.jsx("div",{className:"card p-4 shadow-sm",children:i?e.jsx(L,{queryId:i}):e.jsx("p",{className:"text-muted",children:"Select a query to view its timeline."})})})]})})]})};export{G as default};
